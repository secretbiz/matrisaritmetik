@page
@model MatrisAritmetik.Pages.VeriModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery antiforgery
@{
    var token = antiforgery.GetAndStoreTokens(HttpContext).RequestToken;
}

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Veri Analizi</title>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" asp-append-version="true">

    @* JQuery için *@
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    @* Tablar için *@
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <style>
        .ui-resizable-e {
            width: 14px !important;
            border-right: 7px solid #2d3773 !important;
            margin-right: 2px;
        }
    </style>
</head>
<body>

    @* Nav *@
    <div class="navcolumn_df" onclick="openNav()">
        <span style="font-size:15px;padding-left: 2px">&#9776;</span>
    </div>
    <div id="df_sidenav" class="sidenav">
        <a href="javascript:void(0)">
            <p class="sidenav_linkstitle">
                <u>  Linkler</u>
            </p>
            <span class="closebtn" onclick="closeNav()">
                &times;
            </span>
        </a>
        <a href="/Matris">Matris aritmetiği</a>
        <a href="/Veri">Veri analizi</a>
        <a href="https://github.com/secretbiz/matrisaritmetik">Kaynak Kod</a>
    </div>


    @* Panelleri sarar *@
    <div id="panel_container">

        @* Sol panel *@
        <div id="left_panel_df">

            @* Panel başlığı ve tab satırı *@
            <div id="veri_title_left">
                <h2>Veri Tabloları</h2>

                <div class="container tabrow">

                    @* Tablar *@
                    <ul class="nav nav-tabs" style="width:fit-content">

                        @* Yazıdan *@
                        <li id="veri_create_bytext_parent" class="active"><a id="veri_create_bytext">Yazıdan</a></li>

                        @* Dosyadan *@
                        <li id="veri_create_fromfile_parent" class=""><a id="veri_create_fromfile">Dosyadan</a></li>

                        @* Özel matris dropdown menü partial *@
                        <select id="special_veri_options">
                            <partial name="_SpecialSelectionPartial" model=@ViewData["special_optiondict"] />
                        </select>

                    </ul>

                </div>

            </div>

            @* Matris ekleme bilgileri satırı *@
            <div id="veri_add_table">

                <input type="text" id="veri_name" placeholder="Matris ismi" />
                <span id="veri_add_eqsign">=</span>

                @* Özel matris ekleme inputları*@
                <textarea name="veri_vals_special" id="veri_vals_special" style="display:none" readonly="readonly"></textarea>
                <input type="text" id="veri_special_args" style="display:none" placeholder="Parametre:Değer" />

                @* Text ile matris ekleme inputları*@
                <textarea name="veri_vals" id="veri_vals" placeholder="Elementler"></textarea>

                @*Dosyadan*@
                <input id="veri_file_button" name="veri_file_button" type="file" size="1" accept=".csv,.txt" />

                @* Ayraçlar *@
                <div id="veri_options_column" class="custom_delim_newline">

                    <select class="custom_spacer_select"
                            onchange="document.getElementById('displaySelectedSpacer').value=this.options[this.selectedIndex].text.split(' ')[1]==undefined?' ':this.options[this.selectedIndex].text.split(' ')[1]; document.getElementById('selectedSpacer').value=this.options[this.selectedIndex].value;">
                        <option style="background-color:grey;color:white" value="default">Değer_ayracı  </option>
                        <option value="space">Boşluk  </option>
                        <option value="tab">Tab \t</option>
                        <option value="comma">Virgül ,</option>
                    </select>
                    <input type="text" name="displaySelectedSpacer" id="displaySelectedSpacer"
                           placeholder='Değer_ayracı  ' onfocus="this.select()"
                           class="custom_spacer_displayer">
                    <input name="selectedSpacer" id="selectedSpacer" type="hidden">


                    <select class="custom_newliner_select"
                            onchange="document.getElementById('displaySelectedLiner').value=this.options[this.selectedIndex].text.split(' ')[1]==undefined?' ':this.options[this.selectedIndex].text.split(' ')[1]; document.getElementById('selectedLiner').value=this.options[this.selectedIndex].value;">
                        <option style="background-color:grey;color:white" value="default">Satır_ayracı \n</option>
                        <option value="newline">Yeni_satır \n</option>
                        <option value="semicolon">Notkalı_virgül ;</option>
                    </select>
                    <input type="text" name="displaySelectedLiner" id="displaySelectedLiner"
                           placeholder='Satır_ayracı \n' onfocus="this.select()"
                           class="custom_newliner_displayer">
                    <input name="selectedLiner" id="selectedLiner" type="hidden">

                </div>

                @* Ekleme butonları *@
                <input id="veri_fromfile_create_button" type="button" class="button" value="Dosyayı oku" name="veri_fromfile_create" />
                <input id="veri_add_button" type="button" class="button" value="Oluştur" name="veri_create" currenttab="text" />

            </div>

            @* Kayıtlı dataframe tablosu *@
            <table id="veri_table_base">
                <partial name="_VeriTablePartial" model=@ViewData["df_dict"] />
            </table>

            @* Kayıtlı matris tablosu *@
            <table id="matris_table_base">
                <partial name="_MatrisTablePartial" model=@ViewData["matrix_dict"] />
            </table>
        </div>

        @* Panel bölücü *@
        <div id="panel_split"></div>

        @* Sağ panel *@
        <div id="right_panel_df">

            @* Panel başlığı *@
            <div id="veri_title_right">
                <h2>Veri Derleyici</h2>
            </div>

            @* Komut girme satırı *@
            <div id="veri_komut_panel">

                <span id="matris_komut_satır_df"
                      data-placeholder=">>> (örnek: (A+3)*5) (yardım için: ?)"
                      data-focused-advice="Yardım için '?' yazın"
                      contentEditable="true"
                      spellcheck="false"></span>
                
                <input id="veri_komut_button" type="button" class="button" value="Çözümle" name="veri_komut_btn" data-toggle="tooltip" data-placement="top" title="İfadeyi/Komutu çözümle" />
                <select id="veri_komut_options">
                    <partial name="_CommandSelectionPartial" model=@ViewData["komut_optionsdict"] />
                </select>

            </div>

            @* Komut çıktısı tablosu/bölgesi *@
            <div id="veri_komut_output">
                <table id="veri_komut_table_base">
                    <thead>
                        <tr>
                            <td style="color:white;text-align:left;padding:3px;font-weight:bold">Çıktılar</td>
                        </tr>
                    </thead>

                    @* Çıktılar *@
                    <tbody id="output_body_df">
                        <partial name="_dfOutputPanelPartial" model=@ViewData["output_history"] />
                    </tbody>

                </table>
            </div>
        </div>

    </div>
</body>

@* Tokenlere erişim için *@
<script>if (veri_add_button) { veri_add_button.token = "@token";}</script>
<script>if (veri_komut_button) { veri_komut_button.token = "@token";}</script>
<script>if (veri_fromfile_create_button) { veri_fromfile_create_button.token = "@token";}</script>
@* Ara panel için*@
<script>
    $("#left_panel_df").resizable({
        handleSelector: "#panel_split",
        resizeHeight: false,
    });

</script>
<script>
    function openNav() {
        document.getElementById("df_sidenav").style.width = "250px";
    }

    function closeNav() {
        document.getElementById("df_sidenav").style.width = "0";
    }
</script>
@* Sayfa yenilendiğinde listener'lar için*@
@* TO-DO: Daha düzgün bi yol bul*@
<script>

    function updatedfTable(token) {
        $('#veri_table_base').load('/Veri?handler=UpdateDataframeTable', { __RequestVerificationToken: token }, function () {
            var dfs = document.getElementById("veri_table_base");
            MathJax.Hub.Queue(["Typeset", MathJax.Hub, dfs]);
            // Butonları bul & eventlistener ekle
            var buttons = document.getElementsByName("veri_table_delbutton");
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].addEventListener("click", deleteDataframe, false);
                buttons[i].token = token;
            }

        });
    }

    function updateMatTable(token) {
        $('#matris_table_base').load('/Veri?handler=UpdateMatrisTable', { __RequestVerificationToken: token }, function () {
            var mat = document.getElementById("matris_table_base");
            MathJax.Hub.Queue(["Typeset", MathJax.Hub, mat]);
            // Butonları bul & eventlistener ekle
            var buttons = document.getElementsByName("matris_table_delbutton");
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].addEventListener("click", deleteMatrixDf, false);
                buttons[i].token = token;
            }

        });
    }

    function deleteMatrixDf(event) {
        var tkn = event.currentTarget.token;
        $.ajax(
            {
                type: 'POST',
                url: 'Veri?handler=DeleteMatrix',
                data:
                {
                    __RequestVerificationToken: tkn,
                    "name": event.currentTarget.id,
                },
                success: function (_data) { updateMatTable(tkn); updatedfTable(tkn); },
                error: function (error) { console.log(error); }
            });
    }

    function deleteDataframe(event) {
        var tkn = event.currentTarget.token;
        $.ajax(
            {
                type: 'POST',
                url: 'Veri?handler=DeleteDataframe',
                data:
                {
                    __RequestVerificationToken: tkn,
                    "name": event.currentTarget.id,
                },
                success: function (_data) { updateMatTable(tkn); updatedfTable(tkn); },
                error: function (error) { console.log(error); }
            });
    }
    updateMatTable('@token');
    updatedfTable('@token');
</script>

@{
    if (ViewData != null)
    {
        ViewData.Clear();
    }
}